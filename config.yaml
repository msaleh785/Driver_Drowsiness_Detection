# Driver Drowsiness Detection System Configuration
# Raspberry Pi 4 Optimized

# Face Detection Method
# Options: "mediapipe", "blazeface", "dlib"
face_detection:
  method: "mediapipe"  # Primary face detector
  fallback_method: "dlib"  # Fallback if primary fails
  use_fallback: true  # Enable automatic fallback
  
  # MediaPipe settings (when method = "mediapipe")
  mediapipe:
    max_num_faces: 1
    refine_landmarks: true
    min_detection_confidence: 0.5
    min_tracking_confidence: 0.5
  
  # BlazeFace settings (when method = "blazeface")
  blazeface:
    model_path: "models/blazeface.tflite"
    detection_interval: 3  # Detect every Nth frame (3 = every 3rd frame)
    score_threshold: 0.5
    use_mediapipe_landmarks: true
  
  # dlib settings (when method = "dlib")
  dlib:
    face_detector_model: "models/dlib_face_detector.svm"
    landmark_predictor_model: "models/dlib_landmark_predictor.dat"
    upsample: 1  # Upsampling (0=normal, 1=1x upsampling, 2=2x upsampling)
    min_confidence: 0.0  # dlib doesn't return confidence, set 0.0

# Landmark Detection Method
# Options: "mediapipe", "dlib"
# IMPORTANT: Use MediaPipe for thermal images - dlib trained on RGB, not thermal!
landmark_detection:
  method: "mediapipe"  # Primary landmark detector - MediaPipe best for thermal
  fallback_method: "mediapipe"  # Fallback (same - dlib doesn't work on thermal)
  use_fallback: false  # Disable fallback (mediapipe is only option for thermal)
  
  # MediaPipe settings
  mediapipe:
    max_num_faces: 1
    refine_landmarks: true
    min_detection_confidence: 0.5
    min_tracking_confidence: 0.5
  
  # dlib settings (NOT recommended for thermal - kept for RGB reference)
  dlib:
    landmark_predictor_model: "models/dlib_landmark_predictor.dat"
    return_format: "mediapipe_compatible"  # Convert dlib landmarks to MediaPipe format for compatibility

# Temporal Model Configuration
temporal_model:
  enabled: false  # Set to true to enable TCN/GRU temporal reasoning
  model_type: "tcn"  # Options: "tcn" or "gru"
  model_path: "models/temporal_model.tflite"  # Path to quantized TFLite model
  window_size_seconds: 2.0  # Time window for temporal features (1-2 seconds)
  fps: 15  # Expected FPS for window calculation
  # Model architecture (for reference, actual model loaded from .tflite)
  input_features: 10  # EAR_L, EAR_R, MAR, yaw, pitch, roll, blink_flag, yawn_flag, perclos, head_nod_flag
  hidden_size: 32  # For GRU
  num_layers: 1  # For GRU
  kernel_size: 3  # For TCN
  num_filters: 64  # For TCN

# Calibration System
calibration:
  enabled: false  # Set to true to enable per-driver calibration
  calibration_duration: 20  # Seconds (10-30 recommended)
  profiles_directory: "driver_profiles"  # Where to store/load driver profiles
  auto_calibrate_on_start: false  # Automatically start calibration on startup
  # Default baseline values (used if no profile loaded)
  default_baselines:
    EAR0_L: 0.28
    EAR0_R: 0.27
    MAR0: 0.35
    yaw0: 0.0
    pitch0: -5.0
    roll0: 0.0

# Drowsiness Detection Logic
drowsiness:
  # Temporal model weight (if enabled)
  temporal_weight: 0.7
  # Rule-based weights (if temporal disabled, these are used)
  # Increased yawn_weight so strong/frequent yawning alone can raise
  # the overall drowsiness level to at least a soft alert.
  eye_weight: 0.3
  yawn_weight: 0.5
  head_weight: 0.2
  
  # Multi-indicator decision thresholds
  thresholds:
    pre_alert:
      temporal_score: 0.5
      duration_seconds: 0.5
      min_rules_active: 0
    soft:
      temporal_score: 0.6
      duration_seconds: 0.5
      min_rules_active: 1
    medium:
      temporal_score: 0.7
      duration_seconds: 1.0
      min_rules_active: 2
    critical:
      temporal_score: 0.8
      duration_seconds: 1.5
      min_rules_active: 2
  
  # Rule-based guards (normalized thresholds)
  rules:
    ear_threshold: 0.7  # EAR_norm < 0.7 for >0.5s
    mar_threshold: 1.4  # MAR_norm > 1.4 (frequent yawns)
    yaw_threshold: 0.3  # |yaw_rel| > threshold
    pitch_threshold: 0.3  # |pitch_rel| > threshold
    perclos_threshold: 0.4  # PERCLOS > threshold
  
  # Hysteresis settings (prevent flickering)
  level_consistency_frames: 5  # Frames at new level before transitioning
  allow_immediate_down: true  # Allow immediate decrease in drowsiness level

# Performance Settings
performance:
  target_fps: 30
  frame_skip_enabled: true  # Only applies when using BlazeFace
  max_latency_ms: 2000  # Maximum acceptable latency in milliseconds

# Alert System
alerts:
  enable_audio: true
  enable_visual: true
  # Alert sound files
  sound_files:
    slight: "assets/slight_alert.wav"
    moderate: "assets/moderate_alert.wav"
    severe: "assets/severe_alert.wav"

# Reporting
reporting:
  enabled: true
  save_screenshots: true
  reports_directory: "reports"

